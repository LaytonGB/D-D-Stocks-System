{% extends 'base.html' %}
{% block content %}

<div class="container text-center">
{% comment %} title and undo {% endcomment %}
    <div class="row w-100">
        <h1 class="col">Travel</h1>
        {% if party.journey_count > 0 %}
            <button class="col-auto btn btn-primary">Undo Last Journey</button>
        {% endif %}
    </div>

{% comment %} left half {% endcomment %}
    <div class="row">
        <div class="col-6">
            <h3 class="text-center w-100">Current</h3>
            <h4>{{ current_location.name }}</h4>
            {% if current_location_img %}
                <img src="#" alt="{{current_location.name}} Image">
            {% endif %}
        </div>

{% comment %} right half {% endcomment %}
        <div class="col-6">
            <div class="row col-auto">
                <h3 class="text-center w-100">Change</h3>
                <div class="container">
                    <form action="#" method="post" class="form-group">
                        <select name="change_location_select" id="change_location_select" class="form-control">
                            {% if all_locations %}
                                {% for l in all_locations %}
                                    <option value="{{l.id}}">{{l.name}}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">None Available</option>
                            {% endif %}
                        </select>
                    </form>
                </div>
            </div>

{% comment %} trading section {% endcomment %}
            {% if local_resources %}
            <div class="row mt-4">
                <h3 class="text-center w-100">Trading</h3>
                <div class="row w-100 text-light">
                    <h5 class="col">Resource</h5>
                    <h6 class="col">Buy Price</h6>
                    <h6 class="col">Sell Price</h6>
                </div>
                {% for id, name, buy_price, sell_price in local_resources %}
                    <div class="row w-100">
                        <h5 class="col mx-2">{{ name|capfirst }}</h5>
                        <h6 class="col mx-2">{{ buy_price|floatformat:2 }}</h6>
                        <h6 class="col mx-2">{{ sell_price|floatformat:2 }}</h6>
                    </div>
                {% endfor %}
                <form action="#" method="post" class="form-group row">
                    <select name="resource_select" id="resource_select" class="form-control m-0 col">
                        <option value="">Select resource</option>
                        {% for id, name, b, s in local_resources %}
                            <option value="{{id}}">{{name|capfirst}}</option>
                        {% endfor %}
                    </select>
                    <input type="number" name="resource_buy_amount" id="resource_buy_amount" placeholder="Buy amount" class="form-control mx-2 col">
                    <input type="number" name="resource_sell_amount" id="resource_sell_amount" placeholder="Sell amount" class="form-control mx-2 col">
                </form>
                <div class="row w-100">
                    <h3 class="col" id="trade_output_text"></h3>
                    <h3 class="col" id="trade_output_number"></h3>
                    <button class="btn btn-warning" id="confirm_trade" style="visibility: hidden; opacity: 0%; transition: .5s;">Make the Deal</button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock content %}

{% block script %}
<script type="text/javascript">

(function () {
    // django variables
    const local_resources = {{ local_resources|safe }};

    // add event to location select
    const location_selector = document.getElementById('change_location_select');
    location_selector.addEventListener('change', function () {
        if (this.value != '{{ current_location.id }}') this.submit();
    })

    // trading output
    const trade_resource = document.getElementById('resource_select');
    const buy_quantity = document.getElementById('resource_buy_amount');
    const sell_quantity = document.getElementById('resource_sell_amount');
    const output_text = document.getElementById('trade_output_text');
    const output_number = document.getElementById('trade_output_number');
    const confirm_btn = document.getElementById('confirm_trade');
    buy_quantity.addEventListener('change', function () {
        sell_quantity.value = '';
    });
    sell_quantity.addEventListener('change', function () {
        buy_quantity.value = '';
    });
    [trade_resource, buy_quantity, sell_quantity].forEach(function(x) {
        x.addEventListener('change', update_trade_output);
    });
    function update_trade_output() {
        confirm_btn.style.visibility = 'hidden';
        confirm_btn.style.opacity = '0%';
        if (!trade_resource.value || (!buy_quantity.value && !sell_quantity.value) ) {
            output_text.innerHTML = '';
            output_number.innerHTML = '';
            return;
        }

        const r_id = parseInt(trade_resource.value);
        const prof_loss = buy_quantity.value ? 'Cost' : 'Profit';
        output_text.innerHTML = prof_loss;
        const amount = prof_loss === 'Cost' ? buy_quantity.value : sell_quantity.value;
        const total = prof_loss === 'Cost' ?
            amount * local_resources.find(x => x[0] === r_id)[2]:
            amount * local_resources.find(x => x[0] === r_id)[3];
        output_number.innerHTML = Math.round((total + Number.EPSILON) * 100) / 100;

        setTimeout(function() {
            confirm_btn.style.visibility = 'visible';
            confirm_btn.style.opacity = '100%';
        }, 2000);
    }
})();

</script>
{% endblock script %}
